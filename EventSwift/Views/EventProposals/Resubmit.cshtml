@model EventSwift.Models.EventProposal

@{
    ViewBag.Title = "Resubmit Document";
    ViewBag.SkipNavbar = true;
}

@functions {
    public string GetOfficeDisplay(string office)
    {
        switch (office)
        {
            case "VPAA": return "VP Academic Affairs (VPAA)";
            case "VPF": return "VP Finance (VPF)";
            case "VPA": return "VP Administration (VPA)";
            case "AMU": return "Asset Management Unit (AMU)";
            case "President": return "President";
            default: return office;
        }
    }
}

<div class="d-flex">
    @Html.Partial("~/Views/Shared/_Sidebar.cshtml")

    <div class="flex-grow-1 p-2">
        @Html.Partial("~/Views/Shared/_Navbar.cshtml")

        <div class="d-flex justify-content-between align-items-center mb-3">
            <a href="@Url.Action("Details", "EventProposals", new { id = Model.EventId })" class="btn btn-link" style="color: var(--green); text-decoration: none; font-weight: 500;">
                <i class="bi bi-arrow-left me-1"></i> Back to Event Details
            </a>
        </div>

        @Html.Partial("~/Views/Shared/_SectionHeader.cshtml", new ViewDataDictionary { { "Icon", "bi-arrow-repeat" }, { "Text", "Resubmit Document" }, { "Color", "var(--green)" } })

        <div class="row">
            <div class="col-lg-8">

                <!-- Accordion of Resubmission Guidelines or just Guidelines -->
                <div class="accordion mb-3" id="resubmissionGuidelines">
                    <div class="accordion-item">
                        <h2 class="accordion-header text-primary" id="headingGuidelines">
                            <button class="accordion-button collapsed" type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#collapseGuidelines"
                                    aria-expanded="false"
                                    aria-controls="collapseGuidelines">
                                <i class="bi bi-info-circle me-2"></i>
                                Guidelines
                            </button>
                        </h2>
                        <div id="collapseGuidelines" class="accordion-collapse collapse"
                             aria-labelledby="headingGuidelines"
                             data-bs-parent="#resubmissionGuidelines">
                            <div class="accordion-body">
                                <ul class="list-unstyled mb-0">
                                    <li class="mb-2">
                                        <i class="bi bi-check-circle text-success me-2"></i>
                                        Review all remarks carefully
                                    </li>
                                    <li class="mb-2">
                                        <i class="bi bi-check-circle text-success me-2"></i>
                                        Make necessary corrections
                                    </li>
                                    <li class="mb-2">
                                        <i class="bi bi-check-circle text-success me-2"></i>
                                        Ensure document is complete
                                    </li>
                                    <li class="mb-2">
                                        <i class="bi bi-check-circle text-success me-2"></i>
                                        Upload only PDF files
                                    </li>
                                    <li class="mb-2">
                                        <i class="bi bi-check-circle text-success me-2"></i>
                                        Document will be reviewed again
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Document Details then the feedback and where you can upload -->
                <div class="card shadow-sm border-0">
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h6 class="text-muted mb-2">Document Information</h6>
                                <p><strong>Title:</strong> @Model.Title</p>
                                <p><strong>Target Office:</strong> @GetOfficeDisplay(Model.TargetOfficeRole)</p>
                                <p><strong>Original Submission:</strong> @Model.SubmittedAt.ToString("g")</p>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted mb-2">Current Status</h6>
                                <span class="badge" style="background: var(--red); color: #fff;">
                                    <i class="bi bi-x-circle me-1"></i>Returned
                                </span>
                            </div>
                        </div>

                        @if (Model.Feedbacks != null && Model.Feedbacks.Any())
                        {
                            <div class="alert alert-warning mb-4">
                                <h6 class="mb-3" style="color: var(--green);">
                                    <i class="bi bi-chat-dots me-2"></i>Remarks from Offices
                                </h6>
                                @foreach (var fb in Model.Feedbacks)
                                {
                                    <div class="mb-3">
                                        <strong>@GetOfficeDisplay(fb.Office) Office:</strong>
                                        <p class="mb-1">@fb.Feedback</p>
                                        <small class="text-muted">
                                            <i class="bi bi-clock me-1"></i>@fb.FeedbackDate.ToString("g")
                                        </small>
                                    </div>
                                }
                            </div>
                        }

                        <hr />

                        <h6 class="text-muted mb-3">
                            <i class="bi bi-file-earmark-arrow-up me-2"></i>Upload Corrected Document
                        </h6>

                        @using (Html.BeginForm(null, null, FormMethod.Post, new { enctype = "multipart/form-data", id = "resubmitForm" }))
                        {
                            @Html.AntiForgeryToken()

                            <div class="mb-3">
                                <div class="custom-file-input">
                                    <input type="file" name="uploadedFile" id="uploadedFile" class="form-control" accept=".pdf" required style="display: none;" />
                                    <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('uploadedFile').click();">
                                        <i class="bi bi-file-earmark-arrow-up me-2"></i>Select PDF File
                                    </button>
                                    <span id="file-name" class="ms-2 text-muted small d-block mt-2"></span>
                                </div>
                                <small class="form-text text-muted">
                                    <i class="bi bi-info-circle me-1"></i>Please upload a PDF file with the corrections based on the remarks provided above.
                                </small>
                            </div>

                            <div class="d-flex justify-content-end">
                                <button type="submit" id="resubmitBtn" class="btn text-white" style="background-color: var(--green);">
                                    <i class="bi bi-arrow-repeat me-2"></i>Resubmit Document
                                </button>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Right column no longer needed (guidelines moved above) -->
            <!-- <div class="col-lg-4"></div> -->
        </div>
    </div>
</div>

<!-- Toast container -->
<div aria-live="polite" aria-atomic="true"
     class="position-fixed top-0 end-0 p-3"
     style="z-index: 1080; min-width: 300px;">
    <div id="resubmitToast"
         class="toast align-items-center text-bg-success border-0"
         role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="resubmitToastBody"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto"
                    data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Generic function to show a success/error toast
        function showResubmitToast(message, isError) {
            var toastEl = document.getElementById('resubmitToast');
            var toastBody = document.getElementById('resubmitToastBody');
            if (!toastEl || !toastBody) return;

            toastBody.textContent = message;
            toastEl.classList.remove('text-bg-success', 'text-bg-danger');
            toastEl.classList.add(isError ? 'text-bg-danger' : 'text-bg-success');

            // Use Bootstrap toast if JS is loaded, otherwise simple fallback
            if (window.bootstrap && bootstrap.Toast) {
                var bsToast = bootstrap.Toast.getOrCreateInstance(toastEl, { delay: 3000 });
                bsToast.show();
            } else {
                // Fallback: manually toggle .show so it becomes visible
                toastEl.classList.add('show');
                setTimeout(function () {
                    toastEl.classList.remove('show');
                }, 3000);
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Office display name from server (escape single quotes)
            var officeName = '@(GetOfficeDisplay(Model.TargetOfficeRole).Replace("'", "\\'"))';

            // Custom file input handling
            var fileInput = document.getElementById('uploadedFile');
            var fileNameSpan = document.getElementById('file-name');
            var resubmitForm = document.getElementById('resubmitForm'); // <-- match the form id

            if (fileInput) {
                fileInput.addEventListener('change', function () {
                    if (this.files.length > 0) {
                        var file = this.files[0];
                        var fileName = file.name;
                        var fileExtension = fileName.split('.').pop().toLowerCase();

                        // Check if file is PDF
                        if (fileExtension !== 'pdf') {
                            alert('Only PDF files are allowed. Please select a PDF file.');
                            this.value = ''; // Clear the file input
                            fileNameSpan.textContent = '';
                            return;
                        }

                        fileNameSpan.textContent = fileName;

                        // Toast: "{Document} will be resubmitted to {Office}"
                        showResubmitToast('"' + fileName + '" will be resubmitted to ' + officeName + '.', false);
                    } else {
                        fileNameSpan.textContent = '';
                    }
                });
            }

            // Intercept submit to show toast, then actually submit
            if (resubmitForm) {
                resubmitForm.addEventListener('submit', function (e) {
                    // Avoid infinite loop on programmatic submit
                    if (!resubmitForm.dataset.submitted) {
                        e.preventDefault();

                        // Toast: "Document has been resubmitted"
                        showResubmitToast('Document has been resubmitted.', false);

                        resubmitForm.dataset.submitted = 'true';

                        // Give the toast a moment to appear, then submit
                        setTimeout(function () {
                            resubmitForm.submit();
                        }, 800);
                    }
                });
            }
        });
    </script>
}